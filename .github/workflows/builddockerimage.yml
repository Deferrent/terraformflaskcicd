name: Terraform EC2 Deployment

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v2

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v1
      with:
        aws-access-key-id: '${{ secrets.TF_USER_AWS_KEY }}'
        aws-secret-access-key: '${{ secrets.TF_USER_AWS_SECRET }}'
        aws-region: us-west-1

    - name: Terraform Init
      run: terraform init

    - name: Terraform Plan
      run: terraform plan -out=plan.tfplan

    - name: Terraform Apply
      run: terraform apply -input=false plan.tfplan

    - name: SSH into the EC2 instance
      run: ssh -i "path/to/key.pem" ubuntu@$(terraform output public_ip)

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y python3-pip
        sudo pip3 install -r requirements.txt

    - name: Start the Flask app
      run: |
        nohup python3 flaskweb.py &
